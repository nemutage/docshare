<html>

<head>
  <title>DocShare</title>
  <style>
    body {
      background-color: #D9E5FF;
    }

    button {
      display: inline-block;
      font-size: 1em;
      padding: 0.5em 1em;
      text-decoration: none;
      background: #668ad8;
      color: #FFF;
      border-bottom: solid 4px #627295;
      border-radius: 3px;
    }

    button:active {
      -webkit-transform: translateY(4px);
      transform: translateY(4px);
      border-bottom: none;
    }

    textarea {
      font-size: 1em;
      height: 30%;
      width: 100%;
      border-radius: 10px;
      border: solid 1.5px rgb(125, 138, 173);
      outline: none;
    }

    /*
    #messages {
      width: 100%;
      height: 50%;
      background-color: #ffffff;
      border: solid 1.5px rgb(125, 138, 173);
      overflow: scroll;
      resize: both;
    }
    */
  </style>
</head>

<body>
  <div id="chatbox" class="center">
    <textarea></textarea><br>
  </div><br>
  <textarea id="name"></textarea><br>
  <textarea id="text"></textarea><br>
  <button id="apply">apply</button>



  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>

    $(function () {
      var socket = null;
      var $textarea = $("#chatbox textarea");

      var $text = $("#text");
      var $apply = $("#apply");
      var $name = $("#name");


      if (!window["WebSocket"]) {
        alert("エラー: WebSocketに対応していないブラウザです。")
      } else {
        socket = new WebSocket("ws://{{.Host}}/room");

        socket.onclose = function () {
          alert("接続が終了しました。");
        }

        //受信
        socket.onmessage = function (e) {
          var msg = JSON.parse(e.data);

          if (msg.type == "1") {
            var name = "#" + msg.name;
            var startIndex = $text.val().indexOf(name) + name.length;
            var lastIndex = $text.val().indexOf("#", startIndex);
            var val = $text.val().slice(0, startIndex) + msg.text + $text.val().slice(lastIndex);
            $text.val(val);
          } else if (msg.type == "2") {
            $text.val(msg.text);
          }
        }
      }

      //送信
      $textarea.on("input", function (e) {
        var obj = {
          type: "1",
          name: $name.val(),
          text: $textarea.val()
        }
        socket.send(JSON.stringify(obj));
      })

      $apply.on("click", function () {
        var obj = {
          type: "2",
          name: $name.val(),
          text: $text.val()
        }
        socket.send(JSON.stringify(obj));
      })

    });
  </script>
</body>

</html>